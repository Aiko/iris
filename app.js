/////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////
// Utilities
/////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////
const Sentry = require('@sentry/node') // TODO: ipc
Sentry.init({ dsn: 'https://a5c7cbba227443c09affd9b2aee59dea@sentry.io/1886420' })
const Log = require('./src/js/utils/logger')
Log.log("Starting up")
/////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////
const { app, BrowserWindow } = require('electron')
Log.log("Checking Electron Squirrel Startup")
if (require('electron-squirrel-startup')) app.quit()
/////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////
// Set up OAuth clients
/////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////
const GOAuth2 = require('./src/js/oauth/goauth')
const MSAuth = require('./src/js/oauth/msoauth')

Log.log("Setting up GOauth")
const GOAuth = GOAuth2( // TODO: ipc
  '446179098641-5cafrt7dl4rsqtvi5tjccqrbknurtr7k.apps.googleusercontent.com',
  null, // no client secret if you registered as iOS app! wheeee
  ['https://mail.google.com']
)

Log.log("Setting up MSOauth")
const MSOauth = MSAuth( // TODO: ipc
  '65b77461-4950-4abb-b571-ad129d9923a3'
)
/////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////
// Require mailing tools
/////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////
Log.log("Setting up email IPC")
require('./src/js/mail/email')
const Mailman = require('./src/js/mail/sendmail') // TODO: ipc
/////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////


/////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////
// Set up app preferences
/////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////
const Prefs = require('./src/js/cache/prefs')('prefs.json')
Log.log("Loading preferences")
Prefs.data = Prefs.load()
/////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////

const platform = process.platform;
let win;

const init = () => {
  win = new BrowserWindow({
    show: false,
    frame: false,
    webPreferences: {
      nodeIntegration: true
    },
    // TODO: icon
    icon: './src/public-old/assets/img/icon.png'
  })
  win.maximize()
  win.show()

  entry()

  win.on('closed', () => {
    win = null
  })
}

const entry = () => {
  const signed_in = Prefs.data.authenticated

  if (signed_in) {
    Log.log("User is signed in, loading the main app.")
    win.loadURL(`file://${__dirname}/src/public/index.html`)
  }
  else {
    Log.log("User is not signed in, they will go thru the signin flow.")
    win.loadURL('https://helloaiko.com/email/signin')
  }
}

app.on('ready', init)

app.on('window-all-closed', () => {
  if (platform !== 'darwin') app.quit()
})

app.on('activate', () => {
  if (win === null) init()
})